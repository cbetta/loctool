var Charset=require("./Charset.js");var Charmap=require("./Charmap.js");var IString=require("./IString.js");var UTF8=function(e){this.charset=new Charset({name:"UTF-8"})};UTF8.prototype=new Charmap;UTF8.prototype.parent=Charmap;UTF8.prototype.constructor=UTF8;UTF8.prototype.validate=function(e){var r=0;while(r<e.length){if((e[r]&128)===0){r++}else{var t;if((e[r]&192)===192){t=2}else if((e[r]&224)===224){t=3}else if((e[r]&240)===240){t=4}else{return false}if(r+t>e.length){return false}for(var i=1;i<t;i++){if((e[r+i]&128)!==128){return false}}r+=t}}return true};UTF8.prototype.mapToUnicode=function(e){if(typeof Buffer!=="undefined"){var r=new Buffer(e);return r.toString("utf8")}var t="";var i=0;while(i<e.length){if(e[i]===0){i=e.length}else if((e[i]&128)===0){t+=String.fromCharCode(e[i++])}else if((e[i]&224)===192){if(i+1>=e.length||(e[i+1]&128)!==128){throw"invalid utf-8 bytes"}t+=String.fromCharCode((e[i]&31)<<6|e[i+1]&63);i+=2}else if((e[i]&240)===224){if(i+2>=e.length||(e[i+1]&128)!==128||(e[i+2]&128)!==128){throw"invalid utf-8 bytes"}t+=String.fromCharCode((e[i]&15)<<12|(e[i+1]&63)<<6|e[i+2]&63);i+=3}else if((e[i]&248)===240){if(i+3>=e.length||(e[i+1]&128)!==128||(e[i+2]&128)!==128||(e[i+3]&128)!==128){throw"invalid utf-8 bytes"}t+=IString.fromCodePoint((e[i]&7)<<18|(e[i+1]&63)<<12|(e[i+2]&63)<<6|e[i+3]&63);i+=4}else{throw"invalid utf-8 bytes"}}return t};UTF8.prototype.mapToNative=function(e){if(typeof Buffer!=="undefined"){var r=new Buffer(e,"utf8");return new Uint8Array(r)}var t=e instanceof IString?e:new IString(e);var i=t.iterator();var n=new Uint8Array(t.length*4+1);var a=0;while(i.hasNext()){var f=i.next();if(f>127){if(f>2047){if(f>65535){n[a]=240|f>>18&3;n[a+1]=128|f>>12&63;n[a+2]=128|f>>6&63;n[a+3]=128|f&63;a+=4}else{n[a]=224|f>>12&15;n[a+1]=128|f>>6&63;n[a+2]=128|f&63;a+=3}}else{n[a]=192|f>>6&31;n[a+1]=128|f&63;a+=2}}else{n[a++]=f&127}}n[a]=0;return n};Charmap._algorithms["UTF-8"]=UTF8;module.exports=UTF8;