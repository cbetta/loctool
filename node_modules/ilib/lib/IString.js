var ilib=require("./ilib.js");var Utils=require("./Utils.js");var MathUtils=require("./MathUtils.js");var Locale=require("./Locale.js");var IString=function(t){if(typeof t==="object"){if(t instanceof IString){this.str=t.str}else{this.str=t.toString()}}else if(typeof t==="string"){this.str=new String(t)}else{this.str=""}this.length=this.str.length;this.cpLength=-1;this.localeSpec=ilib.getLocale()};IString._isSurrogate=function(t){var e=t.charCodeAt(0);return e>=56320&&e<=57343||e>=55296&&e<=56319};IString.fromCodePoint=function(t){if(t<65536){return String.fromCharCode(t)}else{var e=Math.floor(t/65536)-1;var n=t&65535;return String.fromCharCode(55296|(e&15)<<6|(n&64512)>>10)+String.fromCharCode(56320|n&1023)}};IString.toCodePoint=function(t,e){if(!t||t.length===0){return-1}var n=-1,r=t.charCodeAt(e);if(r>=55296&&r<=56319){if(t.length>e+1){var i=t.charCodeAt(e+1);if(i>=56320&&i<=57343){n=((r&960)>>6)+1<<16|((r&63)<<10|i&1023)}}}else{n=r}return n};IString.loadPlurals=function(t,e,n,r){var i;if(e){i=typeof e==="string"?new Locale(e):e}else{i=new Locale(ilib.getLocale())}var a=i.getLanguage();if(!ilib.data["plurals_"+a]){Utils.loadData({name:"plurals.json",object:"IString",locale:i,sync:t,loadParams:n,callback:ilib.bind(this,function(t){if(!t){ilib.data.cache.IString[a]={}}ilib.data["plurals_"+a]=t||{};if(r&&typeof r==="function"){r(ilib.data["plurals_"+a])}})})}else{if(r&&typeof r==="function"){r(ilib.data["plurals_"+a])}}};IString._fncs={firstProp:function(t){for(var e in t){if(e&&t[e]){return e}}return undefined},firstPropRule:function(t){if(Object.prototype.toString.call(t)==="[object Array]"){return"inrange"}else if(Object.prototype.toString.call(t)==="[object Object]"){for(var e in t){if(e&&t[e]){return e}}}return undefined},getValue:function(t,e){if(typeof t==="object"){var n=IString._fncs.firstPropRule(t);if(n==="inrange"){return IString._fncs[n](t,e)}return IString._fncs[n](t[n],e)}else if(typeof t==="string"){if(typeof e==="object"){return e[t]}return e}else{return t}},matchRangeContinuous:function(t,e){for(var n in e){if(typeof n!=="undefined"&&typeof e[n]!=="undefined"){var r=e[n];if(typeof r==="number"){if(t===e[n]){return true}else if(t>=e[0]&&t<=e[1]){return true}}else if(Object.prototype.toString.call(r)==="[object Array]"){if(t>=r[0]&&t<=r[1]){return true}}}}return false},calculateNumberDigits:function(t){var e=t.toString();var n=[];var r={};var i={};var a,s,f;if(e.indexOf(".")!==-1){n=e.split(".",2);r.integerPart=parseInt(n[0],10);r.decimalPartLength=n[1].length;r.decimalPart=parseInt(n[1],10);i.n=parseFloat(t);i.i=r.integerPart;i.v=r.decimalPartLength;i.w=r.decimalPartLength;i.f=r.decimalPart;i.t=r.decimalPart}else{r.integerPart=t;r.decimalPartLength=0;r.decimalPart=0;i.n=parseInt(t,10);i.i=r.integerPart;i.v=0;i.w=0;i.f=0;i.t=0}return i},matchRange:function(t,e){return IString._fncs.matchRangeContinuous(t,e)},is:function(t,e){var n=IString._fncs.getValue(t[0],e);var r=IString._fncs.getValue(t[1],e);return n==r},isnot:function(t,e){return IString._fncs.getValue(t[0],e)!=IString._fncs.getValue(t[1],e)},inrange:function(t,e){if(typeof t[0]==="number"){if(typeof e==="object"){return IString._fncs.matchRange(e.n,t)}return IString._fncs.matchRange(e,t)}else if(typeof t[0]==="undefined"){var n=IString._fncs.firstPropRule(t);return IString._fncs[n](t[n],e)}else{return IString._fncs.matchRange(IString._fncs.getValue(t[0],e),t[1])}},notin:function(t,e){return!IString._fncs.matchRange(IString._fncs.getValue(t[0],e),t[1])},within:function(t,e){return IString._fncs.matchRangeContinuous(IString._fncs.getValue(t[0],e),t[1])},mod:function(t,e){return MathUtils.mod(IString._fncs.getValue(t[0],e),IString._fncs.getValue(t[1],e))},n:function(t,e){return e},or:function(t,e){var n=t.length;var r,i;for(i=0;i<n;i++){r=IString._fncs.getValue(t[i],e);if(r){return true}}return false},and:function(t,e){var n=t.length;var r,i;for(i=0;i<n;i++){r=IString._fncs.getValue(t[i],e);if(!r){return false}}return true},eq:function(t,e){var n=IString._fncs.getValue(t[0],e);var r;if(typeof t[0]==="string"){if(typeof e==="object"){r=e[t[0]];if(typeof t[1]==="number"){r=IString._fncs.getValue(t[1],e)}else if(typeof t[1]==="object"&&IString._fncs.firstPropRule(t[1])==="inrange"){r=IString._fncs.getValue(t[1],e)}}}else{if(IString._fncs.firstPropRule(t[1])==="inrange"){r=IString._fncs.getValue(t[1],n)}else{r=IString._fncs.getValue(t[1],e)}}if(typeof r==="boolean"){return r?true:false}else{return n==r?true:false}},neq:function(t,e){var n=IString._fncs.getValue(t[0],e);var r;var i;var a;if(typeof t[0]==="string"){r=e[t[0]];if(typeof t[1]==="number"){r=IString._fncs.getValue(t[1],e)}else if(typeof t[1]==="object"){i=t[1][0];a=t[1][1];if(typeof i==="number"&&typeof a==="number"){if(n>=i&&r<=a){return false}else{return true}}}}else{if(IString._fncs.firstPropRule(t[1])==="inrange"){r=IString._fncs.getValue(t[1],n)}else{r=IString._fncs.getValue(t[1],e)}}if(typeof r==="boolean"){return r?false:true}else{return n!==r?true:false}}};IString.prototype={_length:function(){return this.str.length},format:function(t){var e=this.str;if(t){var n;for(var r in t){if(typeof t[r]!=="undefined"){n=new RegExp("{"+r+"}","g");e=e.replace(n,t[r])}}}return e.toString()},formatChoice:function(t,e){var n=this.str.split("|");var r=typeof t;var i=[];var a=[];var s;var f;var o;var u;var l=undefined;var c="";var g={};var h={};if(this.str.length===0){return""}for(s=0;s<n.length;s++){f=n[s].split("#");if(f.length>2){i[s]=f[0];f=f.shift();a[s]=f.join("#")}else if(f.length===2){i[s]=f[0];a[s]=f[1]}else{throw"syntax error in choice format pattern: "+n[s]}}for(s=0;s<i.length;s++){if(i[s].length===0){c=new IString(a[s])}else{switch(r){case"number":h=IString._fncs.calculateNumberDigits(t);if(i[s].substring(0,2)==="<="){o=parseFloat(i[s].substring(2));if(h.n<=o){l=new IString(a[s]);s=i.length}}else if(i[s].substring(0,2)===">="){o=parseFloat(i[s].substring(2));if(h.n>=o){l=new IString(a[s]);s=i.length}}else if(i[s].charAt(0)==="<"){o=parseFloat(i[s].substring(1));if(h.n<o){l=new IString(a[s]);s=i.length}}else if(i[s].charAt(0)===">"){o=parseFloat(i[s].substring(1));if(h.n>o){l=new IString(a[s]);s=i.length}}else{this.locale=this.locale||new Locale(this.localeSpec);switch(i[s]){case"zero":case"one":case"two":case"few":case"many":var p=ilib.data["plurals_"+this.locale.getLanguage()];if(p){var S=p[i[s]];if(IString._fncs.getValue(S,h)){l=new IString(a[s]);s=i.length}}break;default:var d=i[s].indexOf("-");if(d!==-1){var I=i[s].substring(0,d);var v=i[s].substring(d+1);if(h.n>=parseInt(I,10)&&h.n<=parseInt(v,10)){l=new IString(a[s]);s=i.length}}else if(h.n===parseInt(i[s],10)){l=new IString(a[s]);s=i.length}break}}break;case"boolean":if(i[s]==="true"&&t===true){l=new IString(a[s]);s=i.length}else if(i[s]==="false"&&t===false){l=new IString(a[s]);s=i.length}break;case"string":var b=new RegExp(i[s],"i");if(b.test(t)){l=new IString(a[s]);s=i.length}break;case"object":throw"syntax error: fmtChoice parameter for the argument index cannot be an object"}}}if(!l){l=c||new IString("")}l=l.format(e);return l.toString()},toString:function(){return this.str.toString()},valueOf:function(){return this.str.valueOf()},charAt:function(t){return new IString(this.str.charAt(t))},charCodeAt:function(t){return this.str.charCodeAt(t)},concat:function(t){return new IString(this.str.concat(t))},indexOf:function(t,e){return this.str.indexOf(t,e)},lastIndexOf:function(t,e){return this.str.lastIndexOf(t,e)},match:function(t){return this.str.match(t)},replace:function(t,e){return new IString(this.str.replace(t,e))},search:function(t){return this.str.search(t)},slice:function(t,e){return new IString(this.str.slice(t,e))},split:function(t,e){return this.str.split(t,e)},substr:function(t,e){var n=ilib._getPlatform();if(n==="qt"||n==="rhino"||n==="trireme"){if(typeof e==="undefined"){e=this.str.length-t}}return new IString(this.str.substr(t,e))},substring:function(t,e){return this.str.substring(t,e)},toLowerCase:function(){return this.str.toLowerCase()},toUpperCase:function(){return this.str.toUpperCase()},_toCodePoint:function(t){return IString.toCodePoint(this.str,t)},forEach:function(t){if(typeof t==="function"){var e=this.charIterator();while(e.hasNext()){t(e.next())}}},forEachCodePoint:function(t){if(typeof t==="function"){var e=this.iterator();while(e.hasNext()){t(e.next())}}},iterator:function(){function t(t){this.index=0;this.hasNext=function(){return this.index<t.str.length};this.next=function(){if(this.index<t.str.length){var e=t._toCodePoint(this.index);this.index+=e>65535?2:1}else{e=-1}return e}}return new t(this)},charIterator:function(){function t(t){this.index=0;this.hasNext=function(){return this.index<t.str.length};this.next=function(){var e;if(this.index<t.str.length){e=t.str.charAt(this.index);if(IString._isSurrogate(e)&&this.index+1<t.str.length&&IString._isSurrogate(t.str.charAt(this.index+1))){this.index++;e+=t.str.charAt(this.index)}this.index++}return e}}return new t(this)},codePointAt:function(t){if(t<0){return-1}var e,n=this.iterator(),r;for(e=t;e>=0&&n.hasNext();e--){r=n.next()}return e<0?r:-1},setLocale:function(t,e,n,r){if(typeof t==="object"){this.locale=t}else{this.localeSpec=t;this.locale=new Locale(t)}IString.loadPlurals(typeof e!=="undefined"?e:true,this.locale,n,r)},getLocale:function(){return(this.locale?this.locale.getSpec():this.localeSpec)||ilib.getLocale()},codePointLength:function(){if(this.cpLength===-1){var t=this.iterator();this.cpLength=0;while(t.hasNext()){this.cpLength++;t.next()}}return this.cpLength}};module.exports=IString;