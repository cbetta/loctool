var ilib=require("./ilib.js");var Utils=require("./Utils.js");var Charset=require("./Charset.js");var JSUtils=require("./JSUtils.js");var IString=require("./IString.js");var Charmap=function(e){var a=true,t=undefined;this.charset=new Charset({name:"US-ASCII"});this.missing="placeholder";this.placeholder="?";this.escapeStyle="js";this.expansionFactor=1;if(e){if(typeof e.placeholder!=="undefined"){this.placeholder=e.placeholder}var i={html:"html",js:"js","c#":"js",c:"c","c++":"c",java:"java",ruby:"java",perl:"perl"};if(typeof e.escapeStyle!=="undefined"){if(typeof i[e.escapeStyle]!=="undefined"){this.escapeStyle=i[e.escapeStyle]}}if(typeof e.missing!=="undefined"){if(e.missing==="skip"||e.missing==="placeholder"||e.missing==="escape"){this.missing=e.missing}}}this._calcExpansionFactor()};Charmap._algorithms={};Charmap.prototype={getName:function(){return this.charset.getName()},writeNative:function(e,a,t){if(ilib.isArray(t)){for(var i=0;i<t.length;i++){e[a+i]=t[i]}return t.length}else{e[a]=t;return 1}},writeNativeString:function(e,a,t){for(var i=0;i<t.length;i++){e[a+i]=t.charCodeAt(i)}return t.length},_calcExpansionFactor:function(){var e=1;e=Math.max(e,this.charset.getMaxCharWidth());switch(this.missing){case"placeholder":if(this.placeholder){e=Math.max(e,this.placeholder.length)}break;case"escape":switch(this.escapeStyle){case"html":e=Math.max(e,8);break;case"c":e=Math.max(e,6);break;case"perl":e=Math.max(e,10);break;default:e=Math.max(e,6);break}break;default:break}this.expansionFactor=e},dealWithMissingChar:function(e){var a="";switch(this.missing){case"skip":break;case"escape":var t=typeof e==="string"?e.charCodeAt(0):e;var i=JSUtils.pad(t.toString(16),4).toUpperCase();switch(this.escapeStyle){case"html":a="&#x"+i+";";break;case"c":a="\\x"+i;break;case"java":a="\\\\u"+i;break;case"perl":a="\\N{U+"+i+"}";break;default:case"js":a="\\u"+i;break}break;default:case"placeholder":a=this.placeholder;break}return a},mapToNative:function(e){if(!e){return new Uint8Array(0)}if(this.algorithm){return this.algorithm.mapToNative(e)}var a=e instanceof IString?e:new IString(e);var t,i=0,r=0,s=a.iterator();var h=new Uint8Array(a.length*this.expansionFactor);while(s.hasNext()&&i<h.length){t=s.next();if(t<127){h[i++]=t}else{i+=this.writeNativeString(h,i,this.dealWithMissingChar(t))}}return h},mapToUnicode:function(e){var a="";var t,i=0;while(i<e.length){t=e[i];if(t<128){a+=String.fromCharCode(t)}else{a+=this.dealWithMissingChar(e[i++])}}return a}};module.exports=Charmap;