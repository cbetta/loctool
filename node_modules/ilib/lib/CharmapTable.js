var ilib=require("./ilib.js");var Utils=require("./Utils.js");var Charset=require("./Charset.js");var Charmap=require("./Charmap.js");var IString=require("./IString.js");var CharmapTable=function(e){var a=true,t=undefined;this.parent.call(this,e);if(e){if(typeof e.charset==="object"){this.charset=e.charset}else if(typeof e.name!=="undefined"){this.charset=new Charset({name:e.name})}if(typeof e.sync!=="undefined"){a=e.sync==true}if(typeof e.loadParams!=="undefined"){t=e.loadParams}}if(!this.charset){this.charset=new Charset({name:"ISO-8859-15"})}this._calcExpansionFactor();Utils.loadData({object:"Charmap",locale:"-",nonlocale:true,name:"charmaps/"+this.charset.getName()+".json",sync:a,loadParams:t,callback:ilib.bind(this,function(a){if(!a){throw"No mapping found for "+this.charset.getName()}this.map=a;if(e&&typeof e.onLoad==="function"){e.onLoad(this)}})})};CharmapTable.prototype=new Charmap;CharmapTable.prototype.parent=Charmap;CharmapTable.prototype.constructor=CharmapTable;CharmapTable.prototype._trieWalk=function(e,a,t){function r(e){return typeof e==="string"||typeof e==="number"||typeof e==="object"&&ilib.isArray(e)}var i=undefined,n=t,s=e;while(n<a.length){if(typeof s.__leaf!=="undefined"){i={consumed:n-t+1,value:s.__leaf}}if(a[n]===0){return{consumed:1,value:0}}else if(typeof s[a[n]]!=="undefined"){if(r(s[a[n]])){return{consumed:n-t+1,value:s[a[n]]}}else{s=s[a[n++]]}}else{return i}}return undefined};CharmapTable.prototype.mapToNative=function(e){if(!e){return new Uint8Array(0)}var a=e instanceof IString?e:new IString(e);var t=new Uint8Array(a.length*this.expansionFactor);var r=0,i=0;while(r<e.length){var n=this._trieWalk(this.map.from,e,r);if(n){if(n.value){r+=n.consumed;i+=this.writeNative(t,i,n.value)}else{r=e.length;this.writeNative(t,i,[n.value])}}else{i+=this.writeNativeString(t,i,this.dealWithMissingChar(e[r++]))}}return t.subarray(0,i)};CharmapTable.prototype.mapToUnicode=function(e){var a="";var t=0;while(t<e.length){var r=this._trieWalk(this.map.to,e,t);if(r){if(r.value){t+=r.consumed;if(typeof r.value==="string"){a+=r.value}else if(ilib.isArray(r.value)){for(var i=0;i<r.value.length;i++){a+=r.value[i]}}}else{t=e.length}}else{a+=this.dealWithMissingChar(e[t++])}}return a};Charmap._algorithms["CharmapTable"]=CharmapTable;module.exports=CharmapTable;